# YOLO 신뢰도 문제 분석

> **작성일**: 2026-01-20
> **상태**: 🔴 분석 중
> **우선순위**: P0 (Critical)

---

## 1. 문제 정의

BWMS P&ID 도면에서 YOLO 검출 시 **저신뢰도 검출이 다수 발생**하여 False Positive 위험이 높음.

### 현재 설정
```yaml
model_type: pid_class_aware
confidence: 0.25  # 너무 낮음
iou: 0.45
imgsz: 640
use_sahi: true
```

### 검출 결과 분포

| 신뢰도 구간 | 검출 수 | 비율 | 평가 |
|-------------|---------|------|------|
| 90-100% | 15 | 28% | ✅ 매우 신뢰 |
| 80-90% | 12 | 22% | ✅ 신뢰 |
| 70-80% | 9 | 17% | ⚠️ 검증 필요 |
| 50-70% | 12 | 22% | ⚠️ 주의 |
| 30-50% | 6 | 11% | ❌ 위험 |
| **Total** | **54** | 100% | |

---

## 2. 저신뢰도 클래스 상세 분석

### 2.1 DB&BBV (Double Block & Bleed Valve) - 54%

**원인 분석:**
- 복합 심볼 (2개 밸브 + 블리드 포트)
- 학습 데이터에서 변형이 많음
- 다른 밸브 조합과 혼동

**검출 예시:**
```
Class: DB&BBV
Confidence: 54%
BBox: {"x": 1234, "y": 567, "width": 80, "height": 60}
```

**개선 방향:**
1. DB&BBV 전용 학습 데이터 보강
2. 복합 심볼 인식 후처리 로직 추가
3. 개별 밸브 검출 후 그룹핑

---

### 2.2 Barred Tee - 40%

**원인 분석:**
- 일반 Tee와 시각적 유사성 높음
- Bar 마킹이 작아서 검출 어려움
- 해상도 문제 (640 → 1280 권장)

**혼동 패턴:**
```
Barred Tee (40%) ←→ Tee (미검출)
                 ←→ Reducer (유사 형태)
```

**개선 방향:**
1. `imgsz: 1280` 으로 상향
2. Barred Tee 전용 학습 이미지 추가
3. 신뢰도 40% 미만 필터링

---

### 2.3 Control (32%)

**원인 분석:**
- 클래스 정의가 모호함 ("Control"이 무엇인지 불명확)
- 다른 Control Valve 계열과 중복
- 학습 라벨 품질 문제 의심

**혼동 패턴:**
```
Control (32%) ←→ Control Valve (80%)
              ←→ Control Valve Globe (92%)
              ←→ Sensor (79%)
```

**개선 방향:**
1. "Control" 클래스 정의 명확화
2. Control Valve 계열로 통합 고려
3. 32% 미만 검출 제거

---

### 2.4 DB&BBV + Valve Check (30%)

**원인 분석:**
- 복합 클래스 (두 가지 심볼 조합)
- 학습 데이터 부족
- 단일 BBox로 두 심볼 표현의 한계

**개선 방향:**
1. 복합 클래스 분리 (DB&BBV + Valve Check 각각 검출)
2. 후처리에서 인접 심볼 그룹핑
3. 30% 미만 검출 제거

---

## 3. 실험 계획

### 실험 1: Confidence Threshold 조정

| 설정 | 값 | 예상 효과 |
|------|-----|----------|
| 현재 | 0.25 | 54개 검출, 저신뢰도 다수 |
| 테스트 A | 0.35 | ~45개 검출, 40% 미만 제거 |
| 테스트 B | 0.45 | ~38개 검출, 50% 미만 제거 |
| 테스트 C | 0.50 | ~32개 검출, 고신뢰도만 |

**평가 지표:**
- True Positive Rate (실제 심볼 검출률)
- False Positive Rate (오검출률)
- 평균 신뢰도

---

### 실험 2: 이미지 해상도 증가

| 설정 | 값 | 예상 효과 |
|------|-----|----------|
| 현재 | 640 | 작은 심볼 놓침 |
| 테스트 A | 1024 | 중간 균형 |
| 테스트 B | 1280 | 작은 심볼 개선 |

**Trade-off:**
- 해상도 ↑ → 검출 정확도 ↑, 처리 시간 ↑, VRAM ↑

---

### 실험 3: SAHI 파라미터 조정

| 파라미터 | 현재 | 테스트 범위 |
|----------|------|-------------|
| slice_size | 640 | 480, 640, 800 |
| overlap_ratio | 0.2 | 0.2, 0.3, 0.4 |

---

### 실험 4: NMS (Non-Maximum Suppression) 조정

| 설정 | 값 | 효과 |
|------|-----|------|
| iou | 0.45 | 중복 제거 임계값 |
| 테스트 | 0.35 | 더 공격적인 중복 제거 |
| 테스트 | 0.55 | 더 보수적인 중복 제거 |

---

## 4. 권장 즉시 적용 설정

```yaml
# 현재 → 권장
model_type: pid_class_aware
confidence: 0.35        # 0.25 → 0.35
iou: 0.45              # 유지
imgsz: 1024            # 640 → 1024
use_sahi: true
```

**예상 효과:**
- 저신뢰도 검출 제거 (40% 미만)
- 작은 심볼 검출률 향상
- 처리 시간 약간 증가 (~1-2초)

---

## 5. 장기 개선 방안

### 5.1 모델 Fine-tuning
- BWMS 전용 학습 데이터 구축
- ECS/HYCHLOR 심볼 특화 학습
- PID2Graph 데이터셋 활용 (1000장)

### 5.2 클래스 정의 개선
- 복합 클래스 분리 (DB&BBV 등)
- 모호한 클래스 통합/제거 (Control 등)
- TECHCROSS 표준 심볼 목록과 매핑

### 5.3 후처리 로직 추가
- 신뢰도 기반 필터링
- 인접 심볼 그룹핑
- Human-in-the-Loop 검증 연동

---

## 6. 다음 단계

1. [ ] 실험 1 수행: Confidence 0.35 테스트
2. [ ] 실험 2 수행: imgsz 1024 테스트
3. [ ] 결과 비교 및 최적 설정 도출
4. [ ] BlueprintFlow 템플릿 파라미터 업데이트

---

## 관련 파일

- `EXPERIMENTS.md`: 실험 수행 결과
- `SOLUTION.md`: 최종 해결책
- `../data/`: 테스트 이미지
- `../results/`: 실험 결과 데이터

---

*작성자*: Claude Code (Opus 4.5)
