# YOLO Detection API Specification (통합)
# 기계도면 + P&ID 심볼 검출
# BlueprintFlow 자동 통합을 위한 표준 스펙

apiVersion: v1
kind: APISpec

metadata:
  id: yolo
  name: YOLO (통합)
  version: 2.0.0
  port: 5005
  description: 통합 YOLO API - 기계도면(14종) 및 P&ID(60종) 심볼 검출. 모델 선택으로 용도에 맞게 사용.
  author: AX Team
  tags:
    - detection
    - yolo
    - symbol
    - pid
    - sahi

server:
  endpoint: /api/v1/detect
  method: POST
  contentType: multipart/form-data
  timeout: 120
  healthEndpoint: /api/v1/health

blueprintflow:
  category: detection
  color: "#10b981"
  icon: Target
  requiresImage: true
  recommendedInputs:
    - from: imageinput
      field: image
      reason: 도면 이미지를 입력으로 받아 심볼을 검출합니다

inputs:
  - name: image
    type: Image
    required: true
    description: 분석할 도면 이미지 (JPG, PNG)

outputs:
  - name: detections
    type: DetectionResult[]
    description: 검출된 심볼 목록 (위치, 종류, 신뢰도)
  - name: total_detections
    type: number
    description: 총 검출 개수
  - name: visualized_image
    type: Image
    description: 바운딩 박스가 그려진 시각화 이미지
  - name: processing_time
    type: number
    description: 처리 시간 (초)

parameters:
  - name: model_type
    type: select
    default: engineering
    options:
      - engineering
      - pid_symbol
      - pid_class_agnostic
      - pid_class_aware
      - bom_detector
    description: "모델 선택: engineering(기계도면 14종), pid_symbol(P&ID 60종), pid_class_agnostic(범용), pid_class_aware(32종), bom_detector(전기패널 27종/파나시아)"
    formField: model_type

  - name: confidence
    type: number
    default: 0.25
    min: 0.05
    max: 1
    step: 0.05
    description: 검출 신뢰도 임계값 (P&ID는 0.1 권장)

  - name: iou
    type: number
    default: 0.45
    min: 0
    max: 1
    step: 0.05
    description: NMS IoU 임계값

  - name: imgsz
    type: number
    default: 640
    min: 320
    max: 3520
    step: 32
    description: 입력 이미지 크기 (bom_detector는 3520 권장)

  - name: use_sahi
    type: boolean
    default: false
    description: SAHI 슬라이싱 활성화 (P&ID 모델은 자동 활성화)

  - name: slice_height
    type: number
    default: 512
    min: 256
    max: 2048
    step: 128
    description: SAHI 슬라이스 높이

  - name: slice_width
    type: number
    default: 512
    min: 256
    max: 2048
    step: 128
    description: SAHI 슬라이스 너비

  - name: overlap_ratio
    type: number
    default: 0.25
    min: 0.1
    max: 0.5
    step: 0.05
    description: SAHI 슬라이스 오버랩 비율

  - name: visualize
    type: boolean
    default: true
    description: 결과 시각화 이미지 생성

  - name: task
    type: select
    default: detect
    options:
      - detect
      - segment
    description: 작업 유형 (detect/segment)

mappings:
  output:
    detections: data.detections
    total_detections: data.total_detections
    visualized_image: data.visualized_image
    processing_time: processing_time

i18n:
  ko:
    label: YOLO (통합)
    description: 기계도면(14종) 및 P&ID(60종) 심볼을 검출합니다. 모델 선택으로 용도에 맞게 사용하세요.
    parameters:
      model_type: 모델 선택
      confidence: 신뢰도 임계값
      iou: NMS IoU 임계값
      imgsz: 이미지 크기
      use_sahi: SAHI 슬라이싱
      slice_height: 슬라이스 높이
      slice_width: 슬라이스 너비
      overlap_ratio: 오버랩 비율
      visualize: 시각화 생성
      task: 작업 유형
  en:
    label: YOLO (Unified)
    description: Detects engineering (14 types) and P&ID (60 types) symbols. Select model for your use case.
    parameters:
      model_type: Model Selection
      confidence: Confidence Threshold
      iou: NMS IoU Threshold
      imgsz: Image Size
      use_sahi: SAHI Slicing
      slice_height: Slice Height
      slice_width: Slice Width
      overlap_ratio: Overlap Ratio
      visualize: Generate Visualization
      task: Task Type

examples:
  - 도면 이미지 → YOLO (engineering) → 14가지 기계 심볼 검출
  - 도면 이미지 → YOLO (pid_symbol) → 60가지 P&ID 심볼 검출

usageTips:
  - "기계도면: model_type=engineering, confidence=0.25"
  - "P&ID: model_type=pid_symbol, confidence=0.1 (SAHI 자동)"
  - "전기패널/파나시아: model_type=bom_detector, confidence=0.40, iou=0.50, imgsz=3520"
  - 검출된 영역을 eDOCr2나 PaddleOCR의 입력으로 사용하면 정밀 분석 가능

# 리소스 요구사항
resources:
  gpu:
    vram: "~3GB"
    minVram: 2000
    recommended: "RTX 3060 이상"
    cudaVersion: "11.8+"
  cpu:
    ram: "~4GB"
    minRam: 3072
    cores: 4
    note: "GPU 대비 10배 느림"
  parameterImpact:
    - parameter: model_type
      impact: "P&ID 모델 시 SAHI 자동 활성화"
      examples: "engineering:빠름, pid_symbol:SAHI 사용"
    - parameter: use_sahi
      impact: "SAHI 사용 시 처리시간 증가, 정확도 향상"
      examples: "SAHI 미사용:5초, SAHI:30초"
