# GT Comparison API Spec
# Ground Truth와 검출 결과 비교 API

api_id: gtcomparison
display_name: GT Comparison
version: "1.0"
category: analysis
port: 5020  # Blueprint AI BOM 백엔드 사용
base_url: http://blueprint-ai-bom-backend:5020

description: |
  Ground Truth(정답 라벨)와 YOLO 검출 결과를 비교하여
  정밀도(Precision), 재현율(Recall), F1 스코어를 계산합니다.
  모델 성능 평가 및 개선 포인트 파악에 활용됩니다.

tags:
  - ground-truth
  - evaluation
  - metrics
  - precision
  - recall
  - f1-score

endpoints:
  # GT 파일 목록 조회
  list:
    path: /api/ground-truth
    method: GET
    description: 사용 가능한 GT 파일 목록 조회
    response:
      gt_files:
        type: array
        items:
          type: object
          properties:
            filename:
              type: string
            label_count:
              type: integer
            classes:
              type: array
              items:
                type: string

  # GT 파일 로드
  load:
    path: /api/ground-truth/{filename}
    method: GET
    description: 특정 이미지에 대한 GT 라벨 로드
    parameters:
      filename:
        type: string
        description: 이미지 파일명 (확장자 포함)
      img_width:
        type: integer
        default: 1000
        description: 이미지 너비 (좌표 변환용)
      img_height:
        type: integer
        default: 1000
        description: 이미지 높이 (좌표 변환용)
    response:
      has_ground_truth:
        type: boolean
      labels:
        type: array
        items:
          type: object
          properties:
            class_name:
              type: string
            bbox:
              type: object
              properties:
                x1:
                  type: number
                y1:
                  type: number
                x2:
                  type: number
                y2:
                  type: number

  # GT 비교 실행
  compare:
    path: /api/ground-truth/compare
    method: POST
    description: 검출 결과와 GT 비교하여 메트릭 계산
    parameters:
      filename:
        type: string
        required: true
        description: 이미지 파일명
      detections:
        type: array
        required: true
        description: YOLO 검출 결과 배열
        items:
          type: object
          properties:
            class_name:
              type: string
            bbox:
              type: object
              properties:
                x1:
                  type: number
                y1:
                  type: number
                x2:
                  type: number
                y2:
                  type: number
            confidence:
              type: number
      img_width:
        type: integer
        default: 1000
        description: 이미지 너비
      img_height:
        type: integer
        default: 1000
        description: 이미지 높이
      iou_threshold:
        type: number
        default: 0.5
        min: 0.1
        max: 0.9
        description: IoU 매칭 임계값
      model_type:
        type: string
        default: bom_detector
        enum:
          - bom_detector
          - engineering
          - pid_class_aware
          - pid_symbol
          - custom
        description: 모델 타입 (클래스 목록 결정)
      class_agnostic:
        type: boolean
        default: false
        description: 클래스 무시 모드 (위치만으로 매칭)
    response:
      filename:
        type: string
      has_ground_truth:
        type: boolean
      metrics:
        type: object
        properties:
          tp:
            type: integer
            description: True Positive 개수
          fp:
            type: integer
            description: False Positive 개수
          fn:
            type: integer
            description: False Negative 개수
          precision:
            type: number
            description: 정밀도 (0-100%)
          recall:
            type: number
            description: 재현율 (0-100%)
          f1_score:
            type: number
            description: F1 스코어 (0-100%)
          iou_threshold:
            type: number
      gt_count:
        type: integer
        description: GT 라벨 총 개수
      detection_count:
        type: integer
        description: 검출 결과 총 개수
      tp_matches:
        type: array
        description: TP 매칭 상세
        items:
          type: object
          properties:
            detection_idx:
              type: integer
            gt_idx:
              type: integer
            iou:
              type: number
            det_class:
              type: string
            gt_class:
              type: string
            class_match:
              type: boolean
      fp_detections:
        type: array
        description: FP (오검출) 상세
      fn_labels:
        type: array
        description: FN (미검출) GT 상세

# BlueprintFlow 노드 메타데이터
blueprintflow:
  node_type: gtcomparison
  label: GT Comparison
  category: analysis
  color: "#f97316"
  icon: BarChart3

  inputs:
    - name: detections
      type: Detection[]
      description: YOLO 검출 결과
    - name: image
      type: Image
      description: 원본 이미지 (파일명 참조용)

  outputs:
    - name: metrics
      type: GTMetrics
      description: 평가 지표 (Precision, Recall, F1)
    - name: tp_matches
      type: TPMatch[]
      description: True Positive 매칭 목록
    - name: fp_detections
      type: Detection[]
      description: False Positive 목록
    - name: fn_labels
      type: GTLabel[]
      description: False Negative GT 목록

  parameters:
    - name: gt_file
      type: file
      default: ""
      description: GT 파일 경로
      accept: ".txt,.json,.xml"
    - name: iou_threshold
      type: number
      default: 0.5
      min: 0.1
      max: 0.9
      step: 0.05
      description: IoU 임계값
    - name: class_agnostic
      type: boolean
      default: false
      description: 클래스 무시 모드
    - name: model_type
      type: select
      default: bom_detector
      options:
        - bom_detector
        - engineering
        - pid_class_aware
        - pid_symbol
        - custom
      description: 모델 타입

# 리소스 요구사항
resources:
  cpu:
    ram: "~100MB"
    minRam: 64
    cores: 1
    note: CPU만 사용 (GPU 불필요)
  parameterImpact:
    - parameter: detection_count
      impact: "검출 수↑ → 처리 시간↑"
      examples: "100개: 10ms, 1000개: 100ms"

# OpenAPI Examples (2025-12-31 추가)
openapi:
  requestExamples:
    - name: "기본 GT 비교"
      description: "YOLO 검출 결과와 GT 비교"
      json:
        filename: "test_drawing_001.png"
        detections:
          - class_name: "valve"
            confidence: 0.95
            bbox: {x1: 100, y1: 200, x2: 150, y2: 250}
          - class_name: "pump"
            confidence: 0.88
            bbox: {x1: 300, y1: 400, x2: 380, y2: 480}
        img_width: 1920
        img_height: 1080
        iou_threshold: 0.5
        model_type: "pid_class_aware"

    - name: "클래스 무시 모드"
      description: "위치만으로 매칭"
      json:
        filename: "drawing.png"
        detections: []
        class_agnostic: true
        iou_threshold: 0.3

  responseExamples:
    - name: "성공 응답"
      statusCode: 200
      response:
        status: "success"
        data:
          filename: "test_drawing_001.png"
          has_ground_truth: true
          metrics:
            tp: 18
            fp: 2
            fn: 3
            precision: 90.0
            recall: 85.7
            f1_score: 87.8
            iou_threshold: 0.5
          gt_count: 21
          detection_count: 20
          tp_matches:
            - detection_idx: 0
              gt_idx: 0
              iou: 0.85
              det_class: "valve"
              gt_class: "valve"
              class_match: true
          fp_detections:
            - class_name: "pump"
              confidence: 0.55
              bbox: {x1: 800, y1: 600, x2: 850, y2: 650}
          fn_labels:
            - class_name: "sensor"
              bbox: {x1: 200, y1: 100, x2: 230, y2: 130}
        processing_time: 0.025
