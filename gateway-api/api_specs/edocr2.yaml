# eDOCr2 OCR API Specification
apiVersion: v1
kind: APISpec

metadata:
  id: edocr2
  name: eDOCr2 OCR
  version: 2.0.0
  port: 5002
  description: 기계 도면 특화 OCR - 치수, GD&T, 텍스트 추출
  author: AX Team
  tags:
    - ocr
    - dimension
    - gdt
    - text-extraction

server:
  endpoint: /api/v1/ocr
  method: POST
  contentType: multipart/form-data
  timeout: 120
  healthEndpoint: /api/v2/health

blueprintflow:
  category: ocr
  color: "#3b82f6"
  icon: FileText
  requiresImage: true
  recommendedInputs:
    - from: yolo
      field: detections
      reason: YOLO 검출 영역에서 치수/텍스트를 추출합니다

inputs:
  - name: image
    type: Image
    required: true
    description: 분석할 도면 이미지

outputs:
  - name: dimensions
    type: DimensionData[]
    description: 추출된 치수 목록
  - name: gdt_symbols
    type: GDTSymbol[]
    description: GD&T 기호 목록
  - name: text_blocks
    type: TextBlock[]
    description: 텍스트 블록 목록
  - name: tables
    type: Table[]
    description: 테이블 데이터
  - name: visualized_image
    type: Image
    description: OCR 결과 시각화 이미지

parameters:
  - name: language
    type: select
    default: ko+en
    options:
      - ko
      - en
      - ko+en
      - ja
      - zh
    description: OCR 언어

  - name: extract_dimensions
    type: boolean
    default: true
    description: 치수 추출 활성화

  - name: extract_gdt
    type: boolean
    default: true
    description: GD&T 추출 활성화

  - name: extract_text
    type: boolean
    default: true
    description: 일반 텍스트 추출

  - name: extract_tables
    type: boolean
    default: false
    description: 테이블 추출

  - name: cluster_threshold
    type: number
    default: 50
    min: 10
    max: 200
    description: 텍스트 클러스터링 임계값

  - name: visualize
    type: boolean
    default: true
    description: 결과 시각화 생성

i18n:
  ko:
    label: eDOCr2 OCR
    description: 기계 도면에서 치수, GD&T 기호, 텍스트를 자동 추출합니다
  en:
    label: eDOCr2 OCR
    description: Extracts dimensions, GD&T symbols, and text from engineering drawings

examples:
  - 도면에서 모든 치수값 추출
  - 공차 정보 파싱
  - 부품표 데이터 추출

# OpenAPI Examples (2025-12-31 추가)
openapi:
  requestExamples:
    - name: "기본 치수 추출"
      description: "기계도면에서 치수와 GD&T 추출"
      formData:
        file: "drawing.png"
        language: "ko+en"
        extract_dimensions: true
        extract_gdt: true
        visualize: true

    - name: "테이블 포함 추출"
      description: "BOM 테이블이 포함된 도면 분석"
      formData:
        file: "bom_drawing.png"
        language: "ko+en"
        extract_dimensions: true
        extract_tables: true
        visualize: true

  responseExamples:
    - name: "성공 응답"
      statusCode: 200
      response:
        status: "success"
        data:
          dimensions:
            - value: "50.0"
              tolerance: "±0.1"
              unit: "mm"
              bbox: [100, 200, 200, 230]
              type: "linear"
            - value: "Ø25"
              tolerance: "H7"
              unit: "mm"
              bbox: [300, 150, 380, 180]
              type: "diameter"
          gdt_symbols:
            - symbol: "⌖"
              type: "position"
              tolerance: "0.05"
              datum: ["A", "B"]
              bbox: [400, 300, 500, 350]
          text_blocks:
            - text: "PART NAME"
              bbox: [50, 50, 200, 80]
              confidence: 0.95
          drawing_number: "DWG-001"
          material: "SUS304"
          visualized_image: "data:image/jpeg;base64,..."
        processing_time: 2.45

# 프로파일 기반 기본값 (MODEL_DEFAULTS 패턴)
# 백엔드 models/edocr2-v2-api/config/defaults.py와 동기화
profiles:
  default: full
  available:
    - name: full
      label: "전체 추출"
      description: "치수, GD&T, 텍스트 모두 추출"
      params:
        extract_dimensions: true
        extract_gdt: true
        extract_text: true
        use_vl_model: false
        visualize: false

    - name: dimension_only
      label: "치수만 추출"
      description: "치수 정보만 빠르게 추출"
      params:
        extract_dimensions: true
        extract_gdt: false
        extract_text: false
        visualize: false

    - name: gdt_only
      label: "GD&T만 추출"
      description: "기하공차/데이텀만 추출"
      params:
        extract_dimensions: false
        extract_gdt: true
        extract_text: false
        visualize: false

    - name: text_only
      label: "텍스트만 추출"
      description: "일반 텍스트만 추출"
      params:
        extract_dimensions: false
        extract_gdt: false
        extract_text: true
        visualize: false

    - name: accurate
      label: "정확도 우선"
      description: "VL 모델 사용 + GPU 전처리로 최대 정확도"
      params:
        extract_dimensions: true
        extract_gdt: true
        extract_text: true
        use_vl_model: true
        visualize: true

    - name: fast
      label: "속도 우선"
      description: "치수만 빠르게 추출 (VL 모델 미사용)"
      params:
        extract_dimensions: true
        extract_gdt: false
        extract_text: false
        visualize: false

    - name: debug
      label: "디버그 모드"
      description: "모든 기능 + 시각화 활성화"
      params:
        extract_dimensions: true
        extract_gdt: true
        extract_text: true
        visualize: true

usageTips:
  - YOLO와 함께 사용하면 정확도가 높아집니다
  - 한글+영어 혼합 도면은 ko+en 언어 사용
  - 프로파일 사용 시 개별 파라미터로 덮어쓰기 가능

resources:
  gpu:
    vram: "~2GB"
    minVram: 1500
    recommended: "GTX 1060 이상"
    cudaVersion: "11.8+"
  cpu:
    ram: "~4GB"
    minRam: 2048
    cores: 4
    note: "GPU 대비 3배 느림"
  parameterImpact:
    - parameter: extract_tables
      impact: "테이블 추출 시 메모리 2배"
      examples: "기본:2GB, 테이블:4GB"
