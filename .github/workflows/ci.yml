name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================
  # Frontend (web-ui) - Lint, Build, Test
  # ============================================================
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web-ui

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ./web-ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript build
        run: npm run build

      - name: Run unit tests
        run: npm run test:run

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: frontend-build
          path: web-ui/dist/
          retention-days: 7

  # ============================================================
  # Backend (gateway-api) - Lint, Test
  # ============================================================
  backend:
    name: Backend (Gateway)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./gateway-api

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-gateway-${{ hashFiles('gateway-api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-gateway-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest pytest-asyncio httpx
          pip install -r requirements.txt

      - name: Run ruff linter
        run: ruff check . --ignore E501

      - name: Run pytest
        run: pytest tests/ -v --tb=short -q

  # ============================================================
  # API Services - Basic validation
  # ============================================================
  api-validation:
    name: API Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate API specs (YAML)
        run: |
          pip install pyyaml
          python -c "
          import yaml
          import sys
          from pathlib import Path

          specs_dir = Path('gateway-api/api_specs')
          errors = []

          for yaml_file in specs_dir.glob('*.yaml'):
              try:
                  with open(yaml_file) as f:
                      yaml.safe_load(f)
                  print(f'✓ {yaml_file.name}')
              except Exception as e:
                  errors.append(f'{yaml_file.name}: {e}')
                  print(f'✗ {yaml_file.name}: {e}')

          if errors:
              sys.exit(1)
          print(f'\n✅ All {len(list(specs_dir.glob(\"*.yaml\")))} API specs are valid')
          "

      - name: Check Dockerfile syntax
        run: |
          echo "Checking Dockerfiles..."
          for dockerfile in $(find models -name "Dockerfile" 2>/dev/null); do
            echo "✓ $dockerfile"
          done
          echo "✅ All Dockerfiles found"

  # ============================================================
  # Sync Check - Feature definitions, Node definitions
  # ============================================================
  sync-check:
    name: Sync Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ./web-ui/package-lock.json

      - name: Install dependencies
        run: cd web-ui && npm ci

      - name: Check TypeScript types
        run: cd web-ui && npx tsc --noEmit
        continue-on-error: true

  # ============================================================
  # Docker Build (optional - on main branch only)
  # ============================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: github.ref == 'refs/heads/main'

    strategy:
      matrix:
        service:
          - name: gateway-api
            context: ./gateway-api
          - name: yolo-api
            context: ./models/yolo-api
          - name: design-checker-api
            context: ./models/design-checker-api

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          push: false
          tags: ${{ matrix.service.name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # Summary - Final status
  # ============================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [frontend, backend, api-validation, sync-check]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Validation | ${{ needs.api-validation.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sync Check | ${{ needs.sync-check.result == 'success' && '✅ Passed' || '⚠️ Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.frontend.result }}" != "success" ]] || [[ "${{ needs.backend.result }}" != "success" ]]; then
            echo "❌ CI Pipeline failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ All critical checks passed!" >> $GITHUB_STEP_SUMMARY

      - name: Final status
        if: needs.frontend.result != 'success' || needs.backend.result != 'success'
        run: exit 1
