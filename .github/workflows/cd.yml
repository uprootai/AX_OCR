name: CD Pipeline

on:
  # CI ì™„ë£Œ í›„ ìžë™ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]

  # ìˆ˜ë™ íŠ¸ë¦¬ê±° (í™˜ê²½ ì„ íƒ ê°€ëŠ¥)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: true
        default: 'all'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/ax-poc

jobs:
  # ============================================================
  # Pre-check - CI ì„±ê³µ ì—¬ë¶€ í™•ì¸
  # ============================================================
  pre-check:
    name: Pre-deployment Check
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Check CI status
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger - proceeding with deployment"
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… CI passed - proceeding with deployment"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ CI failed - skipping deployment"
          fi

  # ============================================================
  # Build & Push Docker Images
  # ============================================================
  build-images:
    name: Build Images
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_deploy == 'true'

    strategy:
      matrix:
        include:
          # Core Services
          - service: gateway-api
            context: ./gateway-api
            dockerfile: ./gateway-api/Dockerfile

          # Detection
          - service: yolo-api
            context: ./models/yolo-api
            dockerfile: ./models/yolo-api/Dockerfile

          # OCR Services
          - service: edocr2-v2-api
            context: ./models/edocr2-v2-api
            dockerfile: ./models/edocr2-v2-api/Dockerfile
          - service: paddleocr-api
            context: ./models/paddleocr-api
            dockerfile: ./models/paddleocr-api/Dockerfile

          # Analysis
          - service: design-checker-api
            context: ./models/design-checker-api
            dockerfile: ./models/design-checker-api/Dockerfile
          - service: pid-analyzer-api
            context: ./models/pid-analyzer-api
            dockerfile: ./models/pid-analyzer-api/Dockerfile

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ github.sha }}
          format: spdx-json
          output-file: sbom-${{ matrix.service }}.spdx.json
        continue-on-error: true

  # ============================================================
  # Deploy to Staging
  # ============================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-images
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy notification (start)
        run: |
          echo "## ðŸš€ Deploying to Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Update docker-compose with new images
        run: |
          echo "Updating image tags to: ${{ github.sha }}"
          # ì‹¤ì œ ë°°í¬ ì‹œ ì•„ëž˜ ì£¼ì„ í•´ì œ
          # sed -i "s/:latest/:${{ github.sha }}/g" docker-compose.staging.yml

      - name: Deploy via SSH (placeholder)
        run: |
          echo "ðŸ“¦ Deploying services to staging..."
          echo ""
          echo "Services deployed:"
          echo "  âœ… gateway-api"
          echo "  âœ… yolo-api"
          echo "  âœ… edocr2-v2-api"
          echo "  âœ… paddleocr-api"
          echo "  âœ… design-checker-api"
          echo "  âœ… pid-analyzer-api"

          # ì‹¤ì œ ë°°í¬ ì‹œ SSH ë˜ëŠ” kubectl ëª…ë ¹ ì‚¬ìš©
          # ssh user@staging-server "cd /app && docker-compose pull && docker-compose up -d"

      - name: Health check
        run: |
          echo "ðŸ¥ Running health checks..."
          # ì‹¤ì œ ë°°í¬ ì‹œ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰
          # curl -f https://staging.example.com/health || exit 1
          echo "âœ… All services healthy"

      - name: Deploy notification (complete)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Access: https://staging.example.com" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # Deploy to Production (ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”)
  # ============================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://app.example.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy notification (start)
        run: |
          echo "## ðŸš€ Deploying to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Create deployment record
        run: |
          echo "{
            \"version\": \"${{ github.sha }}\",
            \"deployed_at\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
            \"deployed_by\": \"${{ github.actor }}\",
            \"environment\": \"production\"
          }" > deployment-record.json
          cat deployment-record.json

      - name: Deploy with rolling update
        run: |
          echo "ðŸ“¦ Deploying to production with rolling update..."
          echo ""
          echo "Deployment strategy: Rolling update (1 at a time)"
          echo ""

          services=("gateway-api" "yolo-api" "edocr2-v2-api" "paddleocr-api" "design-checker-api" "pid-analyzer-api")

          for service in "${services[@]}"; do
            echo "  ðŸ”„ Updating $service..."
            sleep 1
            echo "  âœ… $service updated"
          done

          # ì‹¤ì œ ë°°í¬ ì‹œ:
          # kubectl set image deployment/$service $service=$IMAGE:$TAG --record
          # kubectl rollout status deployment/$service

      - name: Production health check
        run: |
          echo "ðŸ¥ Running production health checks..."
          echo ""
          # ì‹¤ì œ ë°°í¬ ì‹œ:
          # for i in {1..5}; do
          #   curl -f https://app.example.com/health && break
          #   sleep 10
          # done
          echo "âœ… All production services healthy"

      - name: Deploy notification (complete)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Access: https://app.example.com" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # Rollback (ì‹¤íŒ¨ ì‹œ)
  # ============================================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()

    steps:
      - name: Rollback notification
        run: |
          echo "## âš ï¸ Deployment Failed - Initiating Rollback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Rolling back to previous stable version..." >> $GITHUB_STEP_SUMMARY

      - name: Perform rollback
        run: |
          echo "ðŸ”„ Rolling back..."
          # ì‹¤ì œ ë¡¤ë°± ì‹œ:
          # kubectl rollout undo deployment/gateway-api
          # docker-compose -f docker-compose.yml up -d --force-recreate
          echo "âœ… Rollback completed"

      - name: Notify team
        run: |
          echo "ðŸ“§ Notifying team of rollback..."
          # Slack/Discord/Email ì•Œë¦¼
          echo "Team notified"

  # ============================================================
  # Deployment Summary
  # ============================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-images, deploy-staging]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Images | ${{ needs.build-images.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Staging | ${{ needs.deploy-staging.result == 'success' && 'âœ…' || needs.deploy-staging.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
