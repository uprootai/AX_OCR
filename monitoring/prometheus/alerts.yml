# Prometheus 알림 규칙
# AI Drawing Analysis System

groups:
  # 서비스 가용성 알림
  - name: service_availability
    interval: 30s
    rules:
      # API 서비스 다운
      - alert: APIServiceDown
        expr: up{job=~"gateway|edocr2|yolo|edgnet|skinmodel|vl|paddleocr|admin-dashboard"} == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "API 서비스가 다운되었습니다"
          description: "{{ $labels.job }} 서비스가 1분 이상 응답하지 않습니다."

      # 다중 서비스 동시 다운
      - alert: MultipleServicesDown
        expr: count(up{job=~"gateway|edocr2|yolo|edgnet|skinmodel|vl|paddleocr"} == 0) >= 3
        for: 2m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "다중 서비스 장애 발생"
          description: "3개 이상의 서비스가 동시에 다운되었습니다. 시스템 전체 점검이 필요합니다."

  # 응답 시간 및 성능 알림
  - name: performance
    interval: 30s
    rules:
      # API 응답 시간 지연
      - alert: HighAPILatency
        expr: http_request_duration_seconds{quantile="0.95"} > 5
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "API 응답 시간이 느립니다"
          description: "{{ $labels.job }} 서비스의 95% 응답 시간이 5초를 초과했습니다. 현재: {{ $value }}s"

      # 요청 처리량 급감
      - alert: RequestRateDropped
        expr: rate(http_requests_total[5m]) < 0.1
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "요청 처리량이 급감했습니다"
          description: "{{ $labels.job }} 서비스의 요청 처리량이 비정상적으로 낮습니다."

      # 에러율 증가
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "높은 에러율 감지"
          description: "{{ $labels.job }} 서비스의 에러율이 5%를 초과했습니다. 현재: {{ $value | humanizePercentage }}"

  # 리소스 사용량 알림
  - name: resource_usage
    interval: 30s
    rules:
      # CPU 사용률 높음
      - alert: HighCPUUsage
        expr: process_cpu_seconds_total > 0.8
        for: 5m
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "CPU 사용률이 높습니다"
          description: "{{ $labels.job }} 서비스의 CPU 사용률이 80%를 초과했습니다."

      # 메모리 사용량 높음
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 4
        for: 5m
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "메모리 사용량이 높습니다"
          description: "{{ $labels.job }} 서비스의 메모리 사용량이 4GB를 초과했습니다. 현재: {{ $value | humanize }}GB"

      # 디스크 공간 부족
      - alert: LowDiskSpace
        expr: node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"} < 0.15
        for: 5m
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "디스크 공간이 부족합니다"
          description: "루트 파일시스템의 여유 공간이 15% 미만입니다."

  # GPU 관련 알림
  - name: gpu_monitoring
    interval: 30s
    rules:
      # GPU 온도 높음
      - alert: HighGPUTemperature
        expr: dcgm_gpu_temp > 80
        for: 3m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "GPU 온도가 높습니다"
          description: "GPU {{ $labels.gpu }} 온도가 80°C를 초과했습니다. 현재: {{ $value }}°C"

      # GPU 메모리 부족
      - alert: HighGPUMemoryUsage
        expr: dcgm_fb_used / dcgm_fb_total > 0.9
        for: 5m
        labels:
          severity: warning
          category: gpu
        annotations:
          summary: "GPU 메모리 사용량이 높습니다"
          description: "GPU {{ $labels.gpu }} 메모리 사용량이 90%를 초과했습니다. 현재: {{ $value | humanizePercentage }}"

  # 학습 작업 모니터링
  - name: training_jobs
    interval: 1m
    rules:
      # 학습 작업 실패
      - alert: TrainingJobFailed
        expr: training_job_status{status="failed"} == 1
        for: 1m
        labels:
          severity: warning
          category: training
        annotations:
          summary: "학습 작업이 실패했습니다"
          description: "학습 작업 {{ $labels.job_id }}이(가) 실패했습니다."

      # 학습 작업 장시간 실행
      - alert: TrainingJobStuck
        expr: time() - training_job_started_timestamp > 14400  # 4시간
        for: 5m
        labels:
          severity: warning
          category: training
        annotations:
          summary: "학습 작업이 비정상적으로 오래 실행 중입니다"
          description: "학습 작업 {{ $labels.job_id }}이(가) 4시간 이상 실행 중입니다. 확인이 필요합니다."

  # 데이터베이스 및 저장소 알림
  - name: storage
    interval: 1m
    rules:
      # 백업 오래됨
      - alert: BackupTooOld
        expr: time() - last_backup_timestamp > 604800  # 7일
        for: 1h
        labels:
          severity: warning
          category: backup
        annotations:
          summary: "백업이 오래되었습니다"
          description: "마지막 백업 후 7일이 경과했습니다. 백업을 수행하세요."

      # 로그 파일 크기 과다
      - alert: LargeLogFiles
        expr: log_directory_size_bytes / 1024 / 1024 / 1024 > 10
        for: 1h
        labels:
          severity: info
          category: storage
        annotations:
          summary: "로그 파일 크기가 큽니다"
          description: "로그 디렉토리 크기가 10GB를 초과했습니다. 정리가 필요합니다."

  # 네트워크 및 연결 알림
  - name: network
    interval: 30s
    rules:
      # 동시 연결 수 높음
      - alert: HighConcurrentConnections
        expr: http_active_connections > 100
        for: 5m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "동시 연결 수가 높습니다"
          description: "{{ $labels.job }} 서비스의 동시 연결 수가 100을 초과했습니다. 현재: {{ $value }}"

      # 요청 큐 백로그
      - alert: RequestQueueBacklog
        expr: http_request_queue_length > 50
        for: 3m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "요청 큐에 백로그가 쌓이고 있습니다"
          description: "{{ $labels.job }} 서비스의 요청 큐에 {{ $value }}개의 대기 요청이 있습니다."

  # 보안 알림
  - name: security
    interval: 1m
    rules:
      # 비정상적인 인증 실패율
      - alert: HighAuthenticationFailureRate
        expr: rate(authentication_failures_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "비정상적인 인증 실패 감지"
          description: "5분간 인증 실패가 {{ $value }}회 발생했습니다. 보안 위협 가능성이 있습니다."

      # 비정상적인 API 요청 패턴
      - alert: AbnormalRequestPattern
        expr: rate(http_requests_total[1m]) > 100
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "비정상적인 요청 패턴 감지"
          description: "{{ $labels.job }} 서비스로의 요청이 비정상적으로 많습니다. DDoS 공격 가능성을 확인하세요."
