# Sub-agent 도입 가이드

> 작성일: 2025-12-22 | 상태: 검토 완료 | 버전: 1.0

---

## 1. Sub-agent 개념 정리

### 1.1 Claude Code 아키텍처 구성 요소

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Claude Code 구성 요소                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📁 CLAUDE.md (프로젝트 메모리)                                      │
│  ├── 역할: 프로젝트 규칙, 지침, 컨텍스트 제공                        │
│  ├── 로드 시점: 항상 자동 로드                                       │
│  ├── 저장 위치: ./CLAUDE.md                                          │
│  └── 현재 상태: ✅ 활성 (잘 구성됨)                                  │
│                                                                      │
│  📁 Skills (전문 기능)                                               │
│  ├── 역할: 특정 작업에 특화된 지침 제공                              │
│  ├── 로드 시점: 필요시 자동 활성화                                   │
│  ├── 저장 위치: .claude/skills/                                      │
│  └── 현재 상태: ✅ 4개 활성 (code-janitor, doc-updater 등)           │
│                                                                      │
│  📁 Commands (슬래시 명령어)                                         │
│  ├── 역할: 반복 작업을 위한 프롬프트 템플릿                          │
│  ├── 호출 방식: /command-name                                        │
│  ├── 저장 위치: .claude/commands/                                    │
│  └── 현재 상태: ✅ 5개 활성 (test-api, debug-issue 등)               │
│                                                                      │
│  📁 Sub-agents (작업 위임)                                           │
│  ├── 역할: 독립적인 컨텍스트에서 작업 처리                           │
│  ├── 실행 위치: Anthropic 클라우드 (로컬 아님!)                      │
│  ├── 저장 위치: .claude/agents/                                      │
│  └── 현재 상태: ❌ 미사용 (테스트 결과 단순 작업에 부적합)           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 Sub-agent 실행 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Sub-agent 실행 흐름                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   로컬 PC                           Anthropic Cloud                  │
│  ┌──────────────┐                  ┌──────────────────────────┐     │
│  │              │                  │                          │     │
│  │ Claude Code  │ ─── API 요청 ──▶ │  Sub-agent 1 (Haiku)    │     │
│  │ CLI          │                  │  Sub-agent 2 (Sonnet)   │     │
│  │              │ ◀── 결과 반환 ── │  Sub-agent 3 (Opus)     │     │
│  │              │                  │                          │     │
│  └──────────────┘                  └──────────────────────────┘     │
│        │                                                             │
│        │ 도구 호출 (Bash, Read 등)                                   │
│        ▼                                                             │
│  ┌──────────────┐                                                    │
│  │ Docker 컨테이너 │  ← 실제 리소스 사용 지점                        │
│  │ (YOLO, OCR 등) │                                                  │
│  └──────────────┘                                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**핵심 포인트:**
- Sub-agent 자체는 클라우드에서 실행 → 로컬 CPU/메모리 거의 사용 안함
- Sub-agent가 호출하는 로컬 도구(curl, docker 등)가 리소스 사용
- LLM API 오버헤드가 실제 작업보다 훨씬 클 수 있음

---

## 2. 실제 테스트 결과 (2025-12-22)

### 2.1 테스트 환경

| 항목 | 사양 |
|------|------|
| CPU | 16코어 |
| RAM | 16GB (6GB 여유) |
| Docker 컨테이너 | 22개 실행 중 (~9.1GB 사용) |
| GPU | RTX 3080 Laptop (8GB VRAM) |

### 2.2 API 헬스체크 성능 비교

| 방식 | 소요시간 | 상대 속도 | API 비용 |
|------|----------|----------|----------|
| **Bash 병렬** | 58ms | 1x (기준) | 무료 |
| Bash 순차 | 122ms | 2x 느림 | 무료 |
| **Sub-agent 병렬 (5개)** | 23,500ms | **400x 느림** | 유료 |

### 2.3 성능 저하 원인 분석

```
Sub-agent 1회 실행 오버헤드:
├── 네트워크 왕복: ~500ms
├── LLM 토큰 처리: ~3,000-4,000ms
├── 응답 파싱: ~500ms
└── 총 오버헤드: ~4,000-5,000ms

실제 작업 (curl 헬스체크): ~4ms

효율성 = 4ms / 5,000ms = 0.08% (매우 비효율)
```

### 2.4 결론

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Sub-agent 효율성 공식                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   효율적 사용 조건:                                                  │
│                                                                      │
│   (실제 LLM 분석 시간) > (API 오버헤드 ~5초) × 3                     │
│                                                                      │
│   즉, 15초 이상의 복잡한 분석 작업에만 Sub-agent가 효율적            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 현재 시스템 제약 사항

### 3.1 하드웨어 제약

```
현재 PC 사양:
├── CPU: 16코어 → Docker 컨테이너 22개 처리 가능
├── RAM: 16GB
│   ├── Docker 사용: ~9.1GB
│   ├── 시스템/기타: ~1GB
│   └── 여유: ~6GB
├── GPU: RTX 3080 8GB
│   ├── 동시 추론: 2-3개 모델 한계
│   └── 대형 모델(VL 등): 1개만 가능
└── 네트워크: 로컬 (Anthropic API 호출 시 인터넷 필요)
```

### 3.2 Sub-agent 동시 실행 시 병목

| 시나리오 | 로컬 리소스 영향 | 병목 지점 |
|----------|-----------------|----------|
| Sub-agent 5개 + curl | 거의 없음 | Anthropic API |
| Sub-agent 5개 + 이미지 분석 | GPU 메모리 부족 | 로컬 GPU |
| Sub-agent 10개 + docker build | CPU/Disk 경합 | 로컬 CPU |

### 3.3 현실적 제약

1. **Anthropic API Rate Limit**: 동시 요청 수 제한
2. **API 비용**: Sub-agent당 토큰 소비 (Haiku < Sonnet < Opus)
3. **네트워크 지연**: 클라우드 왕복 ~500ms
4. **로컬 도구 경합**: 여러 Sub-agent가 동시에 무거운 작업 호출 시

---

## 4. Sub-agent 적합성 매트릭스

### 4.1 작업 유형별 권장 방식

| 작업 유형 | 권장 방식 | 이유 |
|----------|----------|------|
| API 헬스체크 | Bash 병렬 | 400배 빠름, 무료 |
| 로그 분석 (grep) | Bash/Grep 도구 | 로컬에서 즉시 처리 |
| 파일 검색 | Glob/Grep 도구 | 로컬에서 즉시 처리 |
| 단순 테스트 실행 | Bash | npm test, pytest 직접 실행 |
| **코드 리뷰 (10+ 파일)** | **Sub-agent** | 파일별 분석 후 병합 |
| **보안 감사** | **Sub-agent** | 복잡한 패턴 분석 필요 |
| **아키텍처 설계** | **Sub-agent** | 창의적 추론 필요 |
| **문서 생성** | **Sub-agent** | 구조화된 출력 생성 |

### 4.2 Sub-agent 도입 결정 체크리스트

```
Sub-agent 사용 전 확인:

□ 작업이 15초 이상의 LLM 분석을 필요로 하는가?
□ 여러 독립적인 서브태스크로 분리 가능한가?
□ 메인 컨텍스트 분리가 필요한가?
□ Bash/로컬 도구만으로 해결 불가능한가?
□ API 비용 대비 시간 절약 효과가 있는가?

4개 이상 체크 → Sub-agent 사용 권장
3개 이하 → 기존 방식 유지
```

---

## 5. 효율적인 도입 시점 판단 기준

### 5.1 도입 권장 시점

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Sub-agent 도입 권장 시점                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ✅ 즉시 도입 권장                                                   │
│  ├── 대규모 코드 리뷰 필요 (PR에 50+ 파일 변경)                     │
│  ├── 보안 감사 자동화 필요                                          │
│  ├── 복잡한 문서 일괄 생성                                          │
│  └── 여러 독립 분석 작업 병렬 처리                                  │
│                                                                      │
│  ⏳ 조건부 도입 (상황에 따라)                                        │
│  ├── 팀 규모 확대 시 (2명 → 5명+)                                   │
│  ├── Blueprint AI BOM 고도화 시 (심볼/치수/관계 병렬 검증)          │
│  └── CI/CD 파이프라인 복잡도 증가 시                                │
│                                                                      │
│  ❌ 도입 불필요                                                      │
│  ├── 단순 API 호출, 헬스체크                                        │
│  ├── 파일 검색, 로그 분석                                           │
│  ├── 단일 테스트 실행                                               │
│  └── 현재 워크플로우로 충분한 경우                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 시스템 사양별 권장 병렬 수

| 시스템 사양 | 권장 동시 Sub-agent | 주의사항 |
|------------|-------------------|---------|
| 현재 (16코어, 16GB) | 3-5개 | GPU 작업 시 2개로 제한 |
| 고사양 (32코어, 64GB) | 10-15개 | GPU 여유 시 증가 가능 |
| 서버급 (64코어+) | 20개+ | API Rate Limit 확인 필요 |

### 5.3 비용 효율성 계산

```
Sub-agent 사용 시 예상 비용 (Haiku 기준):

입력: ~1,000 토큰 (프롬프트 + 도구 결과)
출력: ~500 토큰 (분석 결과)

Haiku 가격: $0.25/M input, $1.25/M output
1회 비용: ~$0.001 (약 1.3원)

10개 파일 코드 리뷰:
├── 순차 처리: 10분 × $0 = 무료, 시간 10분
├── Sub-agent 병렬: 2분 × $0.01 = 약 13원, 시간 2분
└── 시간 가치 환산: 8분 절약 ≈ 13원 (합리적)

결론: 시간이 중요한 작업에서 Sub-agent는 비용 효율적
```

---

## 6. 향후 도입 계획

### 6.1 Phase별 로드맵

```
Phase 0: 현재 (유지)
├── CLAUDE.md + Skills + Commands 활용
├── Sub-agent 미사용
└── 단순 작업은 Bash 병렬로 처리

Phase 1: 선택적 도입 (필요 시)
├── 대규모 코드 리뷰용 code-reviewer agent
├── 보안 감사용 security-auditor agent
└── 도입 조건: PR 50+ 파일 또는 보안 감사 요청 시

Phase 2: 확장 (팀 확대 시)
├── Blueprint AI BOM 검증용 bom-verifier agent
├── 문서 생성용 doc-generator agent
└── 도입 조건: 팀 3명+ 또는 BOM v2 본격 개발 시

Phase 3: 고도화 (서버 환경 시)
├── CI/CD 통합
├── 자동 코드 리뷰 파이프라인
└── 도입 조건: 전용 서버 또는 클라우드 환경 구축 시
```

### 6.2 도입 시 생성할 Sub-agent 목록

| Agent 이름 | 용도 | 모델 | 도입 Phase |
|------------|------|------|-----------|
| code-reviewer | PR 코드 리뷰 | Sonnet | Phase 1 |
| security-auditor | 보안 취약점 탐지 | Sonnet | Phase 1 |
| bom-verifier | BOM 검증 (심볼/치수/관계) | Sonnet | Phase 2 |
| doc-generator | API 문서 자동 생성 | Haiku | Phase 2 |
| test-analyzer | 테스트 실패 원인 분석 | Sonnet | Phase 3 |

---

## 7. 참고: 테스트 재현 방법

### 7.1 Bash 병렬 헬스체크 (권장)

```bash
# 5개 API 동시 헬스체크 (58ms)
(
  curl -s -w '%{http_code}' http://localhost:5005/api/v1/health &
  curl -s -w '%{http_code}' http://localhost:5002/api/v1/health &
  curl -s -w '%{http_code}' http://localhost:5006/api/v1/health &
  curl -s -w '%{http_code}' http://localhost:8000/api/v1/health &
  curl -s -w '%{http_code}' http://localhost:5009/api/v1/health &
  wait
)
```

### 7.2 Sub-agent 테스트 (비교용)

```
# Claude Code에서 Task 도구로 5개 병렬 실행
# 결과: ~23초 소요 (400배 느림)
# 결론: 단순 작업에는 부적합
```

---

## 8. 결론

```
┌─────────────────────────────────────────────────────────────────────┐
│                         핵심 요약                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  현재 상태:                                                          │
│  ├── Sub-agent 도입 불필요 (현재 워크플로우로 충분)                  │
│  ├── Skills + Commands로 대부분 해결 가능                           │
│  └── 단순 작업은 Bash가 400배 빠름                                  │
│                                                                      │
│  도입 시점:                                                          │
│  ├── 대규모 코드 리뷰 필요 시 (50+ 파일)                            │
│  ├── 보안 감사 자동화 필요 시                                       │
│  ├── Blueprint AI BOM v2 병렬 검증 시                               │
│  └── 팀 규모 확대 시 (3명+)                                         │
│                                                                      │
│  기억할 것:                                                          │
│  ├── Sub-agent ≠ 무조건 빠름                                        │
│  ├── LLM 오버헤드(~5초) > 실제 작업 → 비효율                        │
│  └── 복잡한 분석(15초+)에만 효과적                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

*작성: Claude Code (Opus 4.5) | 테스트일: 2025-12-22*
