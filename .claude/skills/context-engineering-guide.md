# 컨텍스트 엔지니어링 가이드

> **출처**: [sankalp.bearblog.dev - Claude Code 2.0 가이드](https://sankalp.bearblog.dev/my-experience-with-claude-code-20-and-how-to-get-better-at-using-coding-agents/)
>
> **핵심 질문**: "원하는 모델 동작을 생성할 가능성이 가장 높은 컨텍스트 구성이 무엇인가?"

---

## 1. 컨텍스트 윈도우 이해

### LLM의 작업 메모리

| 모델 | 컨텍스트 윈도우 | 대략적 크기 |
|------|----------------|------------|
| Opus 4.5 | 200K 토큰 | ~150,000 단어 |
| Sonnet 4.5 | 200K 토큰 | ~150,000 단어 |

### 토큰 소비 흐름

```
사용자 요청
→ 도구 호출 (자체가 토큰)
→ 도구 결과 (결과도 컨텍스트에 추가)
→ 모델 응답
```

**핵심**: LLM은 **상태 비저장(stateless)**
- 매 요청마다 모든 이전 메시지 재처리
- 도구 호출과 결과가 컨텍스트 팽창 야기

---

## 2. 60% 규칙 ⭐

### 효과적 컨텍스트 = 최대의 50-60%

| 사용률 | 상태 | 권장 조치 |
|--------|------|----------|
| 0-30% | 🟢 안전 | 정상 작업 |
| 30-50% | 🟢 양호 | 복잡한 작업 가능 |
| 50-60% | 🟡 주의 | `/compact` 고려 |
| 60-80% | 🟠 경고 | `/handoff` 또는 `/compact` |
| 80%+ | 🔴 위험 | 즉시 `/handoff` |

### 확인 방법
```
/context
```

### 왜 60%인가?

- **컨텍스트 부패(Context Rot)**: 더 많은 토큰 → 성능 저하
- **주의 메커니즘 한계**: 긴 컨텍스트에서 중간 정보 "잃어버림"
- **Lost-in-the-middle 문제**: 시작과 끝은 기억, 중간은 희미

---

## 3. 컨텍스트 부패 (Context Rot)

### 증상

- 이전에 언급한 내용 잊어버림
- 같은 실수 반복
- 응답 품질 저하
- 지시사항 무시

### 원인

| 원인 | 설명 |
|------|------|
| 임무 난이도 ❌ | 문제가 아님 |
| 컨텍스트 길이 ✅ | 주요 원인 |

### 해결책

1. **`/compact`** - 컨텍스트 압축 (작업 중간)
2. **`/handoff`** - 세션 전환 (작업 완료/전환)
3. **새 세션** - 신선한 컨텍스트로 시작

---

## 4. 탐색 패턴 최적화

### 상황별 도구 선택

| 상황 | 권장 도구 | 이유 |
|------|----------|------|
| 대규모 코드베이스 검색 | `Explore` 에이전트 | 독립 컨텍스트, 효율적 |
| 특정 파일 읽기 | `Read` 도구 | 직접적, 빠름 |
| 클래스/함수 정의 검색 | `Glob` 도구 | 패턴 매칭 |
| 2-3개 파일 내 검색 | `Read` 도구 | 오버헤드 없음 |
| 열린 질문 탐색 | `Explore` 에이전트 | 여러 라운드 검색 |

### Explore 에이전트 활용

```
# 빠른 검색
"quick 수준으로 에러 핸들링 코드 찾아줘"

# 중간 탐색
"medium 수준으로 API 엔드포인트 구조 파악해줘"

# 철저한 분석
"very thorough 수준으로 인증 시스템 전체 분석해줘"
```

**중요**: Explore는 **신선한 컨텍스트**로 시작하므로 컨텍스트 효율적

---

## 5. 온디맨드 로딩 원칙

### CLAUDE.md 최적화

| 원칙 | 설명 |
|------|------|
| **500줄 이하** | 핵심 정보만 포함 |
| **상세 가이드 분리** | `.claude/skills/`로 이동 |
| **필요시 로드** | 트리거 키워드로 자동 로드 |

### 스킬 구조

```
.claude/skills/
├── modularization-guide.md    # 리팩토링 시 로드
├── api-creation-guide.md      # 새 API 추가 시 로드
├── project-reference.md       # R&D/스펙 질문 시 로드
└── version-history.md         # 버전/BOM 질문 시 로드
```

### 효과

- **토큰 절약**: ~60% (매번 전체 로드 → 필요시만)
- **정확도 향상**: 관련 정보만 컨텍스트에 포함

---

## 6. System Reminder 활용

### 목적

긴 컨텍스트에서 **목표 유지** (Lost-in-the-middle 방지)

### 형식

```xml
<system-reminder>
⚠️ 현재 작업: [작업 설명]
참조: [관련 파일/문서]
</system-reminder>
```

### 사용 사례

1. **파일 크기 경고** (Hooks에서 자동 주입)
2. **스킬 리마인더** (특정 키워드 감지 시)
3. **Todo 리스트 갱신** (작업 진행 중)

---

## 7. 복잡한 작업 전략

### `/ultrathink` 활용

| 사용 시기 | 예시 |
|----------|------|
| 변경 사항 검토 | 리팩토링 전 영향 분석 |
| 아키텍처 결정 | 설계 패턴 선택 |
| 디버깅 | 복잡한 버그 원인 분석 |
| 계획 수립 | 다단계 작업 계획 |

### 신선한 컨텍스트에서 시작

복잡한 작업 전:
1. `/context`로 사용률 확인
2. 50% 이상이면 `/compact` 또는 `/handoff`
3. 신선한 상태에서 작업 시작

---

## 8. 실전 워크플로우

### 매일 아침

```
1. /context              # 사용률 확인
2. /test-api gateway     # API 상태 확인
3. 작업 시작
```

### 작업 중간

```
1. 정기적으로 /context 확인
2. 50% 도달 시 /compact
3. 60% 도달 시 /handoff 고려
```

### 복잡한 작업 전

```
1. /context 확인
2. 필요시 /compact 또는 /handoff
3. /ultrathink로 분석
4. 작업 실행
```

### 작업 완료 후

```
1. /context 확인
2. 다음 작업이 복잡하면 /handoff
3. 단순하면 계속 진행
```

---

## 9. 컨텍스트 관리 명령어 요약

| 명령어 | 용도 | 사용 시기 |
|--------|------|----------|
| `/context` | 사용률 확인 | 수시로 |
| `/compact` | 컨텍스트 압축 | 50-60% 도달 시 |
| `/handoff` | 세션 전환 | 60%+ 또는 작업 전환 시 |
| `/ultrathink` | 깊은 사고 | 복잡한 분석/결정 |

---

## 10. 핵심 원칙 요약

1. **60% 규칙 준수** - 효과적 컨텍스트는 최대의 50-60%
2. **온디맨드 로딩** - 필요할 때만 상세 정보 로드
3. **신선한 컨텍스트** - 복잡한 작업은 새 세션에서
4. **Explore 활용** - 대규모 검색은 에이전트에게
5. **System Reminder** - 긴 대화에서 목표 유지
6. **`/ultrathink`** - 중요한 결정 전 깊은 분석

---

## 부록: AX POC 프로젝트 적용

### 설정된 구조

```
.claude/
├── settings.local.json    # Hooks 설정
├── commands/
│   ├── handoff.md         # 세션 핸드오프
│   └── ...
├── skills/
│   ├── modularization-guide.md
│   ├── api-creation-guide.md
│   ├── project-reference.md
│   ├── version-history.md
│   └── context-engineering-guide.md  # 이 문서
├── hooks/
│   ├── pre-edit-check.sh  # 파일 크기 체크
│   └── ...
└── handoff/               # 핸드오프 문서 저장
```

### CLAUDE.md 최적화 결과

| 항목 | Before | After |
|------|--------|-------|
| 줄 수 | 794줄 | 236줄 |
| 토큰 효율 | 매번 전체 | 온디맨드 |
| 개선 | - | **70% 감소** |

---

**마지막 업데이트**: 2026-01-16
