version: '3.8'

# AX 실증산단 - 마이크로서비스 API 시스템
# 전체 시스템 통합 Docker Compose

services:
  # =====================
  # eDOCr2 API (포트 5001)
  # =====================
  edocr2-api:
    build:
      context: ./models/edocr2-api
      dockerfile: Dockerfile
    container_name: edocr2-api
    ports:
      - "5001:5001"
    volumes:
      - /home/uproot/ax/opensource/01-immediate/edocr2/edocr2:/app/edocr2:ro
      - /home/uproot/ax/opensource/01-immediate/edocr2/edocr2/models:/models:ro
      - ./models/edocr2-api/uploads:/tmp/edocr2/uploads
      - ./models/edocr2-api/results:/tmp/edocr2/results
    environment:
      - EDOCR2_PORT=5001
      - EDOCR2_WORKERS=4
      - EDOCR2_MODEL_PATH=/models
      - EDOCR2_LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # eDOCr2 v2 API (포트 5002)
  # =====================
  edocr2-v2-api:
    build:
      context: ./models/edocr2-v2-api
      dockerfile: Dockerfile
    container_name: edocr2-v2-api
    ports:
      - "5002:5002"
    volumes:
      - /home/uproot/ax/opensource/01-immediate/edocr2/edocr2:/app/edocr2:ro
      - /home/uproot/ax/opensource/01-immediate/edocr2/edocr2/models:/models:ro
      - ./models/edocr2-v2-api/uploads:/tmp/edocr2/uploads
      - ./models/edocr2-v2-api/results:/tmp/edocr2/results
    environment:
      - EDOCR2_PORT=5002
      - EDOCR2_WORKERS=4
      - EDOCR2_MODEL_PATH=/models
      - EDOCR2_VERSION=v2
      - EDOCR2_LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/v2/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # EDGNet API (포트 5012)
  # =====================
  edgnet-api:
    build:
      context: ./models/edgnet-api
      dockerfile: Dockerfile
    container_name: edgnet-api
    ports:
      - "5012:5002"
    volumes:
      - /home/uproot/ax/dev/edgnet:/app/edgnet:ro
      - /home/uproot/ax/dev/test_results/sample_tests/graphsage_models:/trained_models:ro
      - ./models/edgnet-api/models:/app/models:ro  # UNet 모델 마운트
      - ./models/edgnet-api/uploads:/tmp/edgnet/uploads
      - ./models/edgnet-api/results:/tmp/edgnet/results
    environment:
      - EDGNET_PORT=5002
      - EDGNET_WORKERS=2
      - EDGNET_MODEL_PATH=/trained_models/graphsage_dimension_classifier.pth
      - EDGNET_LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    # GPU 지원 활성화 ✅
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # Skin Model API (포트 5003)
  # =====================
  skinmodel-api:
    build:
      context: ./models/skinmodel-api
      dockerfile: Dockerfile
    container_name: skinmodel-api
    ports:
      - "5003:5003"
    volumes:
      - ./dev/skinmodel:/app/skinmodel:ro
      - ./models/skinmodel-api/data:/tmp/skinmodel/data
      - ./models/skinmodel-api/output:/tmp/skinmodel/output
    environment:
      - SKINMODEL_PORT=5003
      - SKINMODEL_WORKERS=2
      - SKINMODEL_LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # Vision Language Model API (포트 5004)
  # =====================
  vl-api:
    build:
      context: ./models/vl-api
      dockerfile: Dockerfile
    container_name: vl-api
    ports:
      - "5004:5004"
    volumes:
      - ./models/vl-api/uploads:/tm./models/vl-api/uploads
    environment:
      - VL_API_PORT=5004
      - VL_API_WORKERS=2
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # YOLOv11 API (포트 5005)
  # =====================
  yolo-api:
    build:
      context: ./models/yolo-api
      dockerfile: Dockerfile
    container_name: yolo-api
    ports:
      - "5005:5005"
    volumes:
      - ./models/yolo-api/models:/app/models:ro
      - ./models/yolo-api/uploads:/tm./models/yolo-api/uploads
      - ./models/yolo-api/results:/tm./models/yolo-api/results
    environment:
      - YOLO_API_PORT=5005
      - YOLO_MODEL_PATH=/app/models/best.pt
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    # GPU 지원 활성화 ✅
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # PaddleOCR API (포트 5006)
  # =====================
  paddleocr-api:
    build:
      context: ./models/paddleocr-api
      dockerfile: Dockerfile
    container_name: paddleocr-api
    ports:
      - "5006:5006"
    volumes:
      - ./models/paddleocr-api/uploads:/tm./models/paddleocr-api/uploads
      - ./models/paddleocr-api/results:/tm./models/paddleocr-api/results
    environment:
      - PADDLEOCR_PORT=5006
      - USE_GPU=true
      - USE_ANGLE_CLS=true
      - OCR_LANG=en
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    # GPU 지원 활성화 ✅
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # Gateway API (포트 8000)
  # =====================
  gateway-api:
    build:
      context: ./gateway-api
      dockerfile: Dockerfile
    container_name: gateway-api
    ports:
      - "8000:8000"
    volumes:
      - ./gateway-api/uploads:/tmp/gateway/uploads
      - ./gateway-api/results:/tmp/gateway/results
      - ./datasets:/datasets:ro
    environment:
      - GATEWAY_PORT=8000
      - GATEWAY_WORKERS=4
      - EDOCR_V1_URL=http://edocr2-api:5001
      - EDOCR_V2_URL=http://edocr2-v2-api:5002
      - EDOCR2_URL=http://edocr2-v2-api:5002
      - EDGNET_URL=http://edgnet-api:5002
      - SKINMODEL_URL=http://skinmodel-api:5003
      - VL_API_URL=http://vl-api:5004
      - YOLO_API_URL=http://yolo-api:5005
      - PADDLEOCR_URL=http://paddleocr-api:5006
      - GATEWAY_LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    networks:
      - ax_poc_network
    restart: unless-stopped
    depends_on:
      - edocr2-api
      - edocr2-v2-api
      - edgnet-api
      - skinmodel-api
      - vl-api
      - yolo-api
      - paddleocr-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =====================
  # Web UI (포트 5173)
  # =====================
  web-ui:
    build:
      context: ./web-ui
      dockerfile: Dockerfile
    container_name: web-ui
    ports:
      - "5173:80"
    environment:
      - VITE_GATEWAY_URL=http://localhost:8000
      - VITE_EDOCR2_URL=http://localhost:5001
      - VITE_EDGNET_URL=http://localhost:5012
      - VITE_SKINMODEL_URL=http://localhost:5003
    networks:
      - ax_poc_network
    restart: unless-stopped
    depends_on:
      - gateway-api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80/"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s

networks:
  ax_poc_network:
    name: ax_poc_network
    driver: bridge

volumes:
  edocr2_uploads:
  edocr2_results:
  edgnet_uploads:
  edgnet_results:
  skinmodel_data:
  skinmodel_output:
  yolo_uploads:
  yolo_results:
  gateway_uploads:
  gateway_results:
