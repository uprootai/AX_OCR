# Prometheus Configuration for AX Microservice API System

global:
  # How frequently to scrape targets
  scrape_interval: 15s

  # How long until a scrape request times out
  scrape_timeout: 10s

  # How frequently to evaluate rules
  evaluation_interval: 15s

  # Attach these labels to any time series or alerts
  external_labels:
    monitor: 'ax-microservices'
    environment: 'production'

# Alerting configuration (optional)
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets: ['alertmanager:9093']

# Load rules once and periodically evaluate them
# rule_files:
#   - "alerts/*.yml"

# Scrape configurations
scrape_configs:
  # ============================================================================
  # Gateway API
  # ============================================================================
  - job_name: 'gateway-api'

    # Override global scrape settings
    scrape_interval: 10s
    scrape_timeout: 5s

    # Metrics endpoint
    metrics_path: /metrics

    static_configs:
      - targets: ['gateway-api:8000']
        labels:
          service: 'gateway'
          tier: 'orchestrator'

    # Relabel configurations (optional)
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'gateway-api'

  # ============================================================================
  # eDOCr2 API v1
  # ============================================================================
  - job_name: 'edocr2-api-v1'

    scrape_interval: 15s
    metrics_path: /metrics

    static_configs:
      - targets: ['edocr2-api-v1:5001']
        labels:
          service: 'edocr2'
          version: 'v1'
          tier: 'ocr'

  # ============================================================================
  # eDOCr2 API v2
  # ============================================================================
  - job_name: 'edocr2-api-v2'

    scrape_interval: 15s
    metrics_path: /metrics

    static_configs:
      - targets: ['edocr2-api-v2:5002']
        labels:
          service: 'edocr2'
          version: 'v2'
          tier: 'ocr'

  # ============================================================================
  # EDGNet API
  # ============================================================================
  - job_name: 'edgnet-api'

    scrape_interval: 15s
    metrics_path: /metrics

    static_configs:
      - targets: ['edgnet-api:5012']
        labels:
          service: 'edgnet'
          tier: 'segmentation'

  # ============================================================================
  # Skin Model API
  # ============================================================================
  - job_name: 'skinmodel-api'

    scrape_interval: 15s
    metrics_path: /metrics

    static_configs:
      - targets: ['skinmodel-api:5003']
        labels:
          service: 'skinmodel'
          tier: 'prediction'

  # ============================================================================
  # Prometheus Self-Monitoring
  # ============================================================================
  - job_name: 'prometheus'

    scrape_interval: 30s

    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          tier: 'monitoring'

# ============================================================================
# Useful Queries for Dashboards
# ============================================================================

# Request Rate (per service):
#   rate(http_requests_total[5m])

# Average Response Time (per service):
#   rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])

# Error Rate (per service):
#   rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m])

# OCR Processing Success Rate:
#   rate(ocr_processing_total{status="success"}[5m]) / rate(ocr_processing_total[5m])

# Circuit Breaker State (1=OPEN, 0=CLOSED):
#   circuit_breaker_state

# Dimensions Extracted (total):
#   increase(ocr_dimensions_extracted[1h])

# Request Duration p95:
#   histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# Request Duration p99:
#   histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

# ============================================================================
# Sample Alert Rules (create in alerts/rules.yml)
# ============================================================================

# groups:
#   - name: service_alerts
#     interval: 30s
#     rules:
#       # Alert when error rate > 5%
#       - alert: HighErrorRate
#         expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "High error rate on {{ $labels.service }}"
#           description: "Error rate is {{ $value | humanizePercentage }}"
#
#       # Alert when response time > 10s
#       - alert: HighResponseTime
#         expr: rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m]) > 10
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "High response time on {{ $labels.service }}"
#           description: "Average response time is {{ $value }}s"
#
#       # Alert when circuit breaker is open
#       - alert: CircuitBreakerOpen
#         expr: circuit_breaker_state == 1
#         for: 1m
#         labels:
#           severity: critical
#         annotations:
#           summary: "Circuit breaker open for {{ $labels.service }}"
#           description: "Service {{ $labels.service }} is unavailable"
